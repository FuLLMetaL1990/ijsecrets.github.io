<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <title>Ruby on Rails: CI / CD — ejelome</title> <meta content="Ruby on Rails: CI / CD" name=title /> <meta content="A quick tour for demonstrating CI / CD with Ruby on Rails." name=description /> <meta content=ejelome name=author /> <meta content="width=device-width,initial-scale=1" name=viewport /> <link href=/img/favicon.ico rel="shortcut icon" type=image/x-icon /> <link href=https://ejelome.com/blog/ruby-on-rails-ci-cd rel=canonical /> <script>var script=document.createElement("script");function gtag(){dataLayer.push(arguments)}script.src="//googletagmanager.com/gtag/js?id=UA-144170438-1",document.head.appendChild(script),window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-144170438-1")</script> <script src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js async data-ad-client=ca-pub-3560971753878587></script> <link href=/css/styles.css rel=stylesheet /> </head> <body class=posts> <div class=wrapper> <div class=header> <a href=/ class=navbar-brand> <img alt=ejelome class=site-logo height=64 src=/img/logo.png width=64 /> </a> <div class=site-info> <a href=/ class=site-title>ejelome</a> <p class=site-tagline>Research, Design and Development</p> </div> <ul class=social-media> <li class=github> <a href=https://github.com/ejelome rel=nofollow class=btn data-placement=top data-toggle=tooltip title="GitHub Profile"> <i class="fa-2x fab fa-github"> </i> </a> </li> <li class=youtube> <a href=https://www.youtube.com/channel/UCgqy7fcflZb5hhfLAUmlc5g rel=nofollow class=btn data-placement=top data-toggle=tooltip title="Youtube Channel"> <i class="fa-2x fab fa-youtube"> </i> </a> </li> <li class=linkedin> <a href=https://linkedin.com/in/ejelome rel=nofollow class=btn data-placement=top data-toggle=tooltip title="LinkedIn Profile"> <i class="fa-2x fab fa-linkedin"> </i> </a> </li> </ul> </div> <div class=siri-container> </div> <div class="nav site-nav"> <ul class=list-inline> <li class=list-inline-item> <a href=/ >Home</a> </li> <li class=list-inline-item> <a href=/about>About</a> </li> <li class=list-inline-item> <a href=/archives>Archives</a> </li> </ul> </div> <div class="breadcrumb breadcrumbs"> <a href=/ >Home</a> <span class=separator> <i class="separator fa-caret-right fas"> </i> </span> <a href=/blog>Blog</a> <span class=separator> <i class="separator fa-caret-right fas"> </i> </span> <strong class=active>Ruby on Rails: CI / CD</strong> </div> <div class=main> <div class=sidebar> <div class="sticky-top toc"> <strong>Table of Contents</strong> </div> </div> <div class=content> <h1>Ruby on Rails: CI / CD</h1> <div class=post-content> <div class=post-meta> <span class=author> <i class="fas fa-user"> </i> <a href=/about#about data-toggle=tooltip data-placement=top>ejelome</a> </span> <span class=separator>/</span> <span class=published> <i class="fa-clock far"> </i> <time data-placement=top data-toggle=tooltip datetime=2019-10-26T00:00Z title="Published Date">October 26, 2019</time>  <span class=separator>/</span> <span class=tags> <i class="fas fa-tags"> </i> <a href=/tags/development class=tag data-placement=top data-toggle=tooltip title="Posts tagged with development">development</a> <span class=separator>▪</span> <a href=/tags/ruby class=tag data-placement=top data-toggle=tooltip title="Posts tagged with ruby">ruby</a> <span class=separator>▪</span> <a href=/tags/ruby-on-rails class=tag data-placement=top data-toggle=tooltip title="Posts tagged with ruby-on-rails">ruby-on-rails</a> <span class=separator>▪</span> <a href=/tags/web-application-framework class=tag data-placement=top data-toggle=tooltip title="Posts tagged with web-application-framework">web-application-framework</a> </span> </div> <div class="jumbotron post-summary"> <h2>Summary</h2> <p> This is a quick tour for demonstrating CI (Continuous Integration) and Continuous Delivery (CD) with Ruby on Rails, Travis CI and Heroku. It is quite dense and requires a fair amount of knowledge on the tools and practices specified on the prerequisites. </p> </div> <hr/> <div class=content-block> <p>This is a step-by-step guide to demonstrate Continuous Integration (automated build) and Continuous Delivery (manual deployment) using an application created with Ruby on Rails, Travis CI as the CI build tool and Heroku as the hosting platform to handle CD.</p><h2>Prerequisites</h2><ul><li><a href=https://www.ruby-lang.org rel=nofollow>Ruby</a></li><li><a href=https://rubyonrails.org rel=nofollow>Ruby on Rails</a></li><li><a href=https://git-scm.com rel=nofollow>Git</a></li><li><a href=https://github.com rel=nofollow>GitHub</a> account</li><li><a href=https://guides.github.com/introduction/flow rel=nofollow>GitHub Flow</a></li><li><a href=https://travis-ci.com rel=nofollow>Travis CI</a> account</li><li><a href=https://github.com/travis-ci/travis.rb rel=nofollow>Travis CI Client</a></li><li><a href=https://dashboard.heroku.com rel=nofollow>Heroku</a> account</li><li><a href=https://www.heroku.com/flow rel=nofollow>Heroku Flow</a></li><li><a href=https://devcenter.heroku.com/articles/heroku-cli rel=nofollow>Heroku CLI</a></li></ul><h2>Notable info</h2><ul><li><a href=https://en.wikipedia.org/wiki/Continuous_deployment rel=nofollow>Continuous Deployment</a> (or automated Continuous Delivery) is not supported out of the box in Heroku and is not part of the Heroku Flow</li><li><a href=https://nvie.com/posts/a-successful-git-branching-model rel=nofollow>GitFlow</a>, while very popular, contradicts the very essence of CD / CD (hint: <strong>continuous</strong>); plus overkill for a one-man project like this</li></ul><h2>Legends</h2><p>For consistency, we'll use the following variables so you can modify it with your own:</p><ul><li><code>&lt;username></code> to represent the username</li><li><code>&lt;repo></code> to represent the repo name</li></ul><h2>SCM</h2><p><strong>Note:</strong> SCM stands for <strong>Source Code Management</strong> (also referred to as <a href=https://en.wikipedia.org/wiki/Version_control rel=nofollow>Version Control</a>).</p><h3 id=github>GitHub</h3><ol><li><a href=https://github.com/login rel=nofollow>Sign in</a> (or <a href=https://github.com/join rel=nofollow>Sign up</a> if not registered)</li><li>Create a <a href=https://github.com/new rel=nofollow>new</a> repo</li></ol><h3 id=github_settings>GitHub Settings</h3><p><strong>Note:</strong> These settings are personal preferences, applying them are optional:</p><ul><li><strong>Disable force pushing</strong> on <code>master</code> branch:<ol><li>Go to <strong>Branches</strong> (<code>/&lt;username>/&lt;repo>/settings/branches</code>)</li><li>On <strong>Branch protection rules</strong>, click <strong>Add rule</strong></li><li>On <strong>Branch name pattern</strong>, type <code>master</code></li><li>Click <strong>Create</strong></li></ol></li></ul><h3 id=github_issues>GitHub Issues</h3><ol><li>Create a <strong>New Issue</strong> (<code>/&lt;username>/&lt;repo>/issues/new</code>)</li><li>Enter a <strong>Title</strong> (e.g. <i>Create rails boilerplate</i>)</li><li>Click <strong>Submit new issue</strong></li></ol><h2>App</h2><h3 id=local_repo>Local repo</h3><ol><li>Clone the repo:<pre><code class=shell>$ git clone git@github.com:&lt;username>/&lt;repo>.git
</code></pre></li><li>Move to repo:<pre><code class=shell>$ cd &lt;repo>
</code></pre></li></ol><h3 id=boilerplate>Boilerplate</h3><ol><li>Create the boilerplate:<pre><code class=shell>$ git checkout -b rails-boilerplate
</code></pre></li><li>Generate the rails app:<pre><code class=shell>$ rails new . -f
</code></pre> <strong>Notes:</strong><ul><li><code>.</code> generates the app in the current directory</li><li><code>-f</code> overwrites any existing files</li></ul></li><li>Update the <code>Gemfile</code>:<pre><code class=ruby># File: Gemfile
...
# gem 'sqlite3', '~> 1.4'
...
group :development, :test do
  ...
  gem 'sqlite3'
end

group :production do
  gem 'pg'
end
...
</code></pre></li><li>Install only <code>:development</code> gems:<pre><code>$ bundle --without production
</code></pre></li><li>Apply migration:<pre><code class=shell>$ rails db:migrate
</code></pre></li></ol><h3 id=.travis.yml>.travis.yml</h3><ol><li>Add <code>.travis.yml</code>:<pre><code class=shell>$ \
echo '
language: ruby
cache:
  bundler: true
  yarn: true
  directories:
  - node_modules
bundler_args: "--without production"
script:
- yarn
- bundle exec rails db:migrate
- bundle exec rails t
branches:
  only:
  - master
' > .travis.yml
</code></pre> <strong>Notes:</strong><ul><li>The build begins only when the <code>.travis.yml</code> file is found</li><li>The <code>language</code> uses the <code>ruby</code> environment on Travis CI</li><li>Travis CI uses <code>rvm</code> to provide Ruby implementations</li><li>Since <code>rvm</code> is not specified, it uses<code>.ruby-version</code>'s</li><li>The <code>cache</code> caches installed packages to speedup builds</li><li>The <code>bundler_args</code> adds extra parameters when installing w/ <code>bundler</code></li><li>The <code>script</code> runs <code>bundle install --jobs=3 --retry=3</code> by default</li><li>The <code>script</code> are the commands you type on your terminal locally</li><li>The <code>branches</code> only builds on the specified repo branches</li></ul></li><li>Stage, commit then push:<pre><code class=shell>$ \
git add -A
git commit -m 'Add Rails boilerplate'
git push -u origin rails-boilerplate
</code></pre> <strong>Notes:</strong><ul><li><code>-A</code> is a shortcut for <code>git add .</code> then <code>git add -u</code>.</li><li><code>-u</code> adds upstream reference so the next git push will refer the same branch</li></ul></li></ol><h2>CI</h2><h3 id=travis_ci>Travis CI</h3><p><strong>Note:</strong> Travis CI is <strong>Free for Open Source</strong> projects.</p><ol><li>Go to <a href=https://travis-ci.com rel=nofollow>Travis CI</a></li><li>Click <strong>Sign in with GitHub</strong> or <strong>Sign up with GitHub</strong></li><li>Click <strong>Authorize travis-pro</strong></li><li>Go to <a href=https://travis-ci.com/account rel=nofollow>Settings</a></li><li>On the <strong>Repositories</strong>, click <strong>Activate</strong></li><li>Click <strong>Approve & Install</strong></li><li>Locate the <code>&lt;repo></code> then click <strong>Settings</strong></li></ol><h3 id=travis_ci_settings>Travis CI Settings</h3><p><strong>Note:</strong> These settings are personal preferences, applying them are optional:</p><ul><li>Toggle on <strong>Auto cancel branch builds</strong></li><li>Toggle on <strong>Auto cancel pull request builds</strong></li></ul><p><strong>Notes:</strong></p><ul><li>Travis CI integration can be found on GitHub at <code>/&lt;username>/&lt;repo>/settings/installations</code></li><li>Travis CI build can be found on its website at <code>/&lt;username>/&lt;repo></code></li></ul><h3 id=github_pull_request>GitHub Pull Request</h3><ol><li>Go back to GitHub and open a pull request:<ul><li><strong>Title</strong>: <code>rails-boilerplate</code></li><li><strong>Leave a comment</strong>: <code>Closes #1: Create rails boilerplate</code></li><li>Click <strong>Create pull request</strong></li></ul></li><li>A check called <strong>Travis CI - Pull Request</strong> should appear</li><li>Wait for the check to complete then go to <strong>Branches</strong> and update GitHub Settings</li></ol><h3 id=re:_github_settings>Re: GitHub Settings</h3><p><strong>Note:</strong> These settings are personal preferences, applying them are optional:</p><ol><li>Go to <strong>Branches</strong> <code>/&lt;username>/&lt;repo>/settings/branches</code></li><li>On <strong>Branch protection rules</strong>, click <strong>Edit</strong></li><li>Switch on the following:<ul><li><strong>Require status checks to pass before merging</strong></li><li><strong>Require branches to be up to date before merging</strong></li><li><strong>Travis CI - Pull Request</strong></li><li><strong>Include administrators</strong></li></ul></li><li>Click <strong>Save changes</strong></li></ol><h3 id=readme:_build_status>README: Build Status</h3><ol><li>Update local repo's <code>README</code> with:<pre><code class=html># &lt;repo> [![Build Status](https://travis-ci.com/&lt;username>/&lt;repo>.svg?branch=master)](https://travis-ci.com/&lt;username>/&lt;repo>)
</code></pre></li><li>Stage, commit then push</li><li>The same checks should appear <br/><strong>Note:</strong> Except this time, <strong>Merge pull request</strong> is unclickable until checks are complete.</li></ol><h2>CD</h2><h3 id=heroku>Heroku</h3><p><a href=https://id.heroku.com/login rel=nofollow>Login</a> (or <a href=https://signup.heroku.com rel=nofollow>Sign up</a> if not registered)</p><h3 id=pipelines>Pipelines</h3><h4 id=staging>Staging</h4><ol><li><a href=https://dashboard.heroku.com/new-app rel=nofollow>Create New App</a><ul><li><strong>App name</strong>: <code>staging-&lt;repo></code></li><li><strong>Choose a region</strong>: <code>Europe</code></li><li><strong>Add to pipeline...</strong> > <strong>Add this app to a pipeline</strong> > <strong>Create new pipeline</strong>:<ul><li><strong>Name the pipeline</strong>: <code>staging-&lt;repo></code></li><li><strong>Choose a stage to add this to</strong>: <code>staging</code></li></ul></li><li>Click <strong>Create app</strong></li></ul></li><li>On <strong>Deployment method</strong>, click <strong>GitHub</strong></li><li>On <strong>Connect to GitHub</strong>, click <strong>Connect to GitHub</strong></li><li>Click <strong>Authorize heroku</strong></li><li>On <strong>Connect to GitHub</strong>, type repo <code>&lt;repo></code> in <strong>repo-name</strong> then click <strong>Search</strong></li><li>Locate the <code>&lt;repo></code> then click <strong>Connect</strong></li><li>On <strong>Automatic deploys</strong><ul><li>On <strong>Choose a branch to deploy</strong>, select <code>master</code></li><li>Switch on <strong>Wait for CI to pass before deploy</strong></li><li>Click <strong>Enable Automatic Deploys</strong></li></ul></li></ol><h4 id=production>Production</h4><ol><li>On <strong>Connected to a pipeline</strong>, click <strong>pipeline overview</strong></li><li>On <strong>PRODUCTION</strong> column, click <strong>Add app</strong></li><li>Click <strong>Create new app...</strong><ul><li><strong>App name</strong>: <code>&lt;repo></code></li><li><strong>Choose a region</strong>: <code>Europe</code></li><li>Click <strong>Create app</strong></li></ul></li><li>Click <code>&lt;repo></code></li><li>On <strong>Installed add-ons</strong>, click <strong>Configure Add-ons</strong></li><li>On <strong>Add-ons</strong>, type <code>pos</code>, then select <strong>Heroku Postgres</strong></li><li>On <strong>Plan name</strong>, select <strong>Hobby Dev - Free</strong>, then click <strong>Provision</strong></li><li>Go back to <strong>Dashboard</strong>, then click <code>staging-&lt;repo></code></li></ol><h3 id=review_apps>Review Apps</h3><ol><li>Update local repo with <code>app.json</code>:<pre><code class=shell>$ echo '
{
  "name": "&lt;repo>",
  "scripts": {},
  "env": {},
  "formation": {},
  "addons": [],
  "buildpacks": [],
  "stack": "heroku-18"
}
' > app.json
</code></pre></li><li>Stage, commit then push</li></ol><h3 id=heroku_cli>Heroku CLI</h3><ol><li>Install <a href=https://devcenter.heroku.com/articles/heroku-cli rel=nofollow>Heroku CLI</a>:<pre><code class=shell>$ yay -S heroku-cli
</code></pre></li><li>Log in (interactively):<pre><code class=shell>$ heroku login -i
</code></pre> <strong>Notes:</strong><ul><li><code>-i</code> is a shortcut for <code>--interactive</code></li><li><code>-i</code> uses the terminal-based login flow instead of opening a web browser</li></ul></li></ol><h3 id=re:_.travis.yml>Re: .travis.yml</h3><ol><li>Install <code>travis</code>:<pre><code class=shell>$ gem install travis
</code></pre></li><li>Update <code>.travis.yml</code>:<pre><code class=yaml># File: .travis.yml
...
deploy:
  provider: heroku
  api_key:
    secure: &lt;token>
  app: staging-&lt;repo>
  on:
    repo: &lt;username>/&lt;repo>
</code></pre></li><li>Log in on Travis CI:<pre><code class=shell>$ travis login --pro --auto
</code></pre> <strong>Notes:</strong><ul><li>Use GitHub login credentials to log in</li><li><code>--pro</code> distinguishes un/paid services</li><li><code>--auto</code> skips password authentication</li></ul></li><li>Encrypt Heroku auth token:<pre><code class=shell>$ travis encrypt $(heroku auth:token) \
                 --add deploy.api_key \
                 --com
</code></pre> <strong>Notes:</strong><ul><li><code>--add deploy.api_key</code> automatically adds the encrypted token to <code>deploy.api_key.secret</code>.</li><li><code>--com</code> distinguishes un/paid services</li></ul></li><li>Stage, commit then push</li><li>Go back to GitHub, <strong>Merge pull request</strong> then <strong>Confirm merge</strong></li></ol><h3 id=re:_review_apps>Re: Review Apps</h3><ol><li>Go back to Dashboard, then click <code>&lt;repo></code></li><li>On <strong>REVIEW APPS</strong>, click <strong>Enable Review Apps...</strong></li><li>Switch on <strong>Create new review apps for new pull requests automatically</strong> <br/><strong>Enable this option if you want every new pull request to create an app.</strong></li><li>Click <strong>Enable</strong></li></ol><p><strong>Note:</strong></p><ul><li>There should be an accessible heroku app whenever a new pull request is made (or updated)</li><li>Temporary environment for PRs becomes available at <code>staging-&lt;repo>-pr-&lt;n>.herokuapp.com</code></li></ul><h3 id=promote_to_production>Promote to Production</h3><ol><li>Click <strong>Promote to Production</strong></li><li>Click <strong>Promote</strong></li></ol><p>This is Continuous Delivery.</p><p><strong>Congratulations!</strong> We now learned how to do CI / CD with Ruby on Rails :)</p> </div> </div> <div class=pagination> <a href=/blog/ruby-on-rails-custom-domain-and-ssl class="btn btn-outline-secondary previous"> <i class="fas fa-angle-left"> </i> Ruby on Rails: Custom Domain and SSL </a> <div class=separator> <i class="fas fa-yin-yang"> </i> </div> <a href=/blog/ruby-on-rails-test-driven-development class="btn btn-outline-secondary next">Ruby on Rails: Test-driven development <i class="fas fa-angle-right"> </i> </a> </div> <hr/> <div class=post-comments> <h2>Comments</h2> <div id=disqus_thread> </div> <script>var disqus_config=function(){this.page.url="https://ejelome.com/blog/ruby-on-rails-ci-cd",this.page.identifier="Ruby on Rails: CI / CD"};!function(){var e=document,t=e.createElement("script");t.src="//ejelome.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script> <noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a> </noscript> </div> </div> </div> </div> <div class=footer> <p>Copyright © 2019 <a href=/ >ejelome</a>. Some rights reserved. </p> </div> <script src=/js/scripts.js></script> </body> </html> 